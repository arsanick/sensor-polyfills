<!DOCTYPE html>
<html>
<head>
<title>Sensor Data</title>
<style>
    #check, #x {
      font-size: 5em;
      display: none;
    }
    @media (max-width: 600px) {
      #check, #x {
        font-size: 3em;
      }
    }
  </style>
</head>
<body>

</h1>Sensor Data </h1>

</h2>Geolocation Data</h2>

<div id="geolocation-data">
    <p>Latitude: <span id="latitude">0</span></p>
    <p>Longitude: <span id="longitude">0</span></p>
</div>

</h2>Absolute Orientation Data</h2>

<div id="orientation-data">
  <p>Absolute Orientation Quaternion:</p>
  <p>Roll: <span id="roll">0</span></p>
  <p>Pitch: <span id="pitch">0</span></p>
  <p>yaw: <span id="yaw">0</span></p>
  <div id="status"></div>
</div>


<script type="module">
// Import the AbsoluteOrientationSensor class
import { AbsoluteOrientationSensor } from './src/motion-sensors.js'; // Replace with the actual path to your implementation

// Function to convert quaternion to Euler angles in degrees
function quaternionToEuler(q) {
  const x = q[0], y = q[1], z = q[2], w = q[3];

  // Roll (x-axis rotation)
  const roll = Math.atan2(2 * (w * x + y * z), 1 - 2 * (x * x + y * y));

  // Pitch (y-axis rotation)
  let pitch = Math.asin(2 * (w * y - z * x));

  // Yaw (z-axis rotation)
  let yaw = Math.atan2(2 * (w * z + x * y), 1 - 2 * (y * y + z * z));

  // Convert radians to degrees
  const rollDeg = roll * 180 / Math.PI;
  const pitchDeg = pitch * 180 / Math.PI;
  const yawDeg = yaw * 180 / Math.PI;

  return { roll: rollDeg, pitch: pitchDeg, yaw: yawDeg };
}

// Options for the AbsoluteOrientationSensor
const options = { frequency: 60, referenceFrame: "device" };

// Create a new AbsoluteOrientationSensor instance
const sensor = new AbsoluteOrientationSensor(options);

// Event listener for reading the sensor data
sensor.addEventListener("reading", () => {
  // Access the quaternion data
  const quaternion = sensor.quaternion;
    // Convert quaternion to Euler angles
  const eulerAngles = quaternionToEuler(quaternion);
    // Update the orientation data on the page
  document.querySelector('#roll').textContent = eulerAngles.roll.toFixed(2);
  document.querySelector('#pitch').textContent = eulerAngles.pitch.toFixed(2);
  document.querySelector('#yaw').textContent = eulerAngles.yaw.toFixed(2);
});

// Event listener for handling errors
sensor.addEventListener("error", (event) => {
  if (event.error.name === "NotReadableError") {
    console.log("Sensor is not available.");
  }
});

// Start the orientation sensor
sensor.start();

// Geolocation code
function requestGeolocationPermission() {
  if ("permissions" in navigator) {
    navigator.permissions.query({ name: 'geolocation' }).then(function(result) {
      if (result.state === 'granted') {
        getGeolocation();
      } else if (result.state === 'prompt') {
        result.onchange = function() {
          getGeolocation();
        };
      } else {
        console.error("Geolocation permission was denied.");
      }
    });
  } else {
    console.error("Permissions API is not available in this browser.");
  }
}

function getGeolocation() {
  if ("geolocation" in navigator) {
    navigator.geolocation.getCurrentPosition(successCallback, errorCallback);
  } else {
    console.error("Geolocation is not available.");
  }
}

function successCallback(position) {
            const latitudeElement = document.querySelector('#latitude');
            const longitudeElement = document.querySelector('#longitude');
            latitudeElement.textContent = position.coords.latitude.toFixed(2);
            longitudeElement.textContent = position.coords.longitude.toFixed(2);

            // Check the yaw angle and update the graphics
            const yaw = eulerAngles.yaw;
            const statusElement = document.getElementById('status');
            statusElement.innerHTML = ''; // Clear previous content
            if (yaw > -20 && yaw < 20) {
                const checkElement = document.createElement('span');
                checkElement.className = 'check';
                checkElement.textContent = '✔️';
                statusElement.appendChild(checkElement);
            } else {
                const xElement = document.createElement('span');
                xElement.className = 'x';
                xElement.textContent = '❌';
                statusElement.appendChild(xElement);
            }
}

function errorCallback(error) {
  alert(`ERROR(${error.code}): ${error.message}`);
}

// Request geolocation permission when the page loads
requestGeolocationPermission();
</script>

</body>
</html>